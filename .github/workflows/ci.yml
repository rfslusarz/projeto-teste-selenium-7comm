name: CI - Testes e RelatÃ³rios Allure

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  MAVEN_OPTS: -Dmaven.repo.local=${{ github.workspace }}/.m2/repository
  JAVA_VERSION: '11'

jobs:
  # Job de verificaÃ§Ã£o de cÃ³digo (compilaÃ§Ã£o e anÃ¡lise estÃ¡tica)
  code-quality:
    name: VerificaÃ§Ã£o de CÃ³digo
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache de dependÃªncias Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Compilar projeto
        run: mvn clean compile -DskipTests

      - name: Verificar formataÃ§Ã£o de cÃ³digo
        run: mvn checkstyle:check || echo "Checkstyle nÃ£o configurado, pulando verificaÃ§Ã£o"

  # Job de testes em paralelo
  tests:
    name: Executar Testes
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        test-suite: [api, ui, all]
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache de dependÃªncias Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Instalar dependÃªncias do sistema para Selenium
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            chromium-browser \
            chromium-chromedriver \
            xvfb

      - name: Configurar display virtual para testes headless
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        if: matrix.test-suite == 'ui' || matrix.test-suite == 'all'

      - name: Executar testes API
        if: matrix.test-suite == 'api'
        run: |
          mvn clean test \
            -Dtest="**/api/**/*Tests" \
            -Dheadless=true \
            -Dbrowser=chrome \
            -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Executar testes UI
        if: matrix.test-suite == 'ui'
        run: |
          export DISPLAY=:99
          mvn clean test \
            -Dtest="**/ui/**/*Tests" \
            -Dheadless=true \
            -Dbrowser=chrome \
            -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Executar todos os testes
        if: matrix.test-suite == 'all'
        run: |
          export DISPLAY=:99
          mvn clean test \
            -Dheadless=true \
            -Dbrowser=chrome \
            -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Gerar relatÃ³rio Allure
        if: always()
        run: |
          mvn allure:report -Dmaven.test.failure.ignore=true
        continue-on-error: true

      - name: Publicar relatÃ³rio Allure como artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.test-suite }}
          path: target/site/allure-maven-plugin/
          retention-days: 30
          if-no-files-found: warn

      - name: Publicar resultados dos testes
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            target/surefire-reports/
            target/allure-results/
          retention-days: 7
          if-no-files-found: warn

  # Job consolidado para gerar relatÃ³rio final
  generate-allure-report:
    name: Gerar RelatÃ³rio Allure Consolidado
    runs-on: ubuntu-latest
    needs: [tests]
    if: always()
    timeout-minutes: 15
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache de dependÃªncias Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Baixar todos os resultados de testes
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: target/allure-results

      - name: Gerar relatÃ³rio Allure consolidado
        if: always()
        run: |
          mvn allure:report || echo "Nenhum resultado de teste encontrado"
        continue-on-error: true

      - name: Publicar relatÃ³rio Allure consolidado
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-consolidado
          path: target/site/allure-maven-plugin/
          retention-days: 30
          if-no-files-found: warn

      - name: Comentar PR com link do relatÃ³rio (se PR)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'target/site/allure-maven-plugin/index.html';
            if (fs.existsSync(path)) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ðŸ“Š RelatÃ³rio Allure gerado com sucesso! Baixe o artefato "allure-report-consolidado" para visualizar.'
              });
            }

  # Job de resumo final
  summary:
    name: Resumo da ExecuÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [code-quality, tests, generate-allure-report]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Resumo da execuÃ§Ã£o
        run: |
          echo "## ðŸ“‹ Resumo da ExecuÃ§Ã£o CI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VerificaÃ§Ã£o de cÃ³digo: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª Testes: ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š RelatÃ³rio Allure: ${{ needs.generate-allure-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Baixe os artefatos para visualizar os relatÃ³rios detalhados do Allure." >> $GITHUB_STEP_SUMMARY
